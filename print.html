<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Megaclite Book</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">The Megaclite Book</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="contract.html"><strong aria-hidden="true">1.</strong> Contract</a></li><li class="chapter-item expanded "><a href="example.html"><strong aria-hidden="true">2.</strong> Example</a></li><li class="chapter-item expanded "><a href="benchmark.html"><strong aria-hidden="true">3.</strong> Benchmark</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="milestones/index.html">Milestones</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Megaclite Book</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/patractlabs/megaclite" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="megaclite"><a class="header" href="#megaclite">Megaclite</a></h1>
<p><a href="https://patractlabs.github.io/megaclite">Megaclite</a> is a zero-knowledge proof tool set building for the Polkadot ecology. </p>
<ul>
<li><a href="https://patractlabs.github.io/megaclite/pairing">Pairing</a></li>
<li><a href="https://patractlabs.github.io/megaclite/pallet-contracts">Pallet Contracts</a></li>
<li><a href="https://patractlabs.github.io/megaclite/metis">Metis</a></li>
</ul>
<ul>
<li>Polkadot Treasury report for v0.1: https://polkadot.polkassembly.io/post/221. </li>
<li>Element group for discussion: https://app.element.io/#/room/#PatractLabsDev:matrix.org</li>
</ul>
<h2 id="zk-rollup-introduction"><a class="header" href="#zk-rollup-introduction">ZK Rollup Introduction</a></h2>
<p>Compared with the privacy function, the performance improvement brought by Rollup is the
early application direction of zero-knowledge proof. At present, the Layer 2 expansion
plan of the blockchain is to transfer a considerable part of the on-chain workload to 
off-chain to complete, and the most watched one is ZK Rollup. The essence of ZK Rollup 
is to compress the application on-chain state and store it in a Merkle tree, and move 
the state transition funtions to off-chain. At the same time, the correctness of the 
off-chain state transition process is guaranteed through the proof of zkSNARK. Compared 
with the high cost of directly processing state changes on the chain, the ZK Proof's 
on-chain smart contract verification is extremely cost low. At the same time, the 
compressed information will also be submitted to the chain together with the proof, 
which ensures data availability and obtains the same level of security as Layer 1.</p>
<p>The Ethereum Layer 2 protocols related to ZK Rollup are: <a href="https://zksync.io/">zkSync</a>, <a href="https://aztec.network/">aztec</a>, 
etc. Their contract verification modules share a part of the elliptic curve's basic algorithms. 
In 2017, Ethereum integrated three basic cryptographic calculation units of the alt
bn128 curve in the form of pre-compiled contracts, which are <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-196.md">EIP196</a>’s ADD and Scalar_MUL 
algorithms, and <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-197.md">EIP197</a>’s Pairing algorithm. On top of this, due to the lack of rapid 
upgrade capabilities of Ethereum, the community can only encapsulate some  tool libraries 
through costly Solidity contracts. On top of these basic contract  libraries, many DApps can combine 
ZK Rollup technology to achieve some innovations, such as <a href="https://loopring.org/">loopring</a>, <a href="https://gitcoin.co/">gitcoin</a> 
and <a href="https://uniswap.org/">uniswap</a> etc. However, in the past 3 years, ZK technology has further developed, 
such as the more practical <a href="https://electriccoin.co/blog/new-snark-curve/">BLS curve</a>, and <a href="https://eprint.iacr.org/2019/953/20190827:165656">PLONK algorithm</a> etc. 
Ethereum has not yet supported it.</p>
<h2 id="license"><a class="header" href="#license">LICENSE</a></h2>
<p>Apache-2.0</p>
<h1 id="contract"><a class="header" href="#contract">Contract</a></h1>
<blockquote>
<p>Currently we are testing with <strong>CHAIN_EXTENSION</strong>, this chapter is <strong>OUTDATED</strong> Now, 
will be updated after the merging of <a href="https://github.com/paritytech/substrate/pull/7548">#7548</a>
and <a href="https://github.com/paritytech/ink/pull/592">#592</a></p>
</blockquote>
<p>Here we did some modifications on <a href="https://github.com/paritytech/substrate.git">paritytech/substrate</a>, added the
curves mentioned in last chapters into <code>runtime_interfaces</code>, for more detail, check the 
<a href="https://github.com/patractlabs/substrate/tree/patract-contracts/frame/contracts">pallet-contracts</a>.</p>
<pre><code class="language-toml">[dependencies.pallet-contracts]
git = &quot;https://github.com/patractlabs/substrate&quot;
branch = &quot;patract-contracts&quot;
</code></pre>
<p>We also modified <a href="https://github.com/patractlabs/ink">ink!</a> to adapt the new interfaces we provided,
all of these modifications will test on <a href="https://github.com/paritytech/jupiter.git">patractlabs/jupiter</a> in the 
future, and will pr to the offical repos if they are accepted by the Polkadot Ecology.</p>
<pre><code class="language-toml">[dependencies.jupiter-ink-lang]
git = &quot;https://github.com/patractlabs/ink&quot;
branch = &quot;megaclite&quot;
</code></pre>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<pre><code class="language-rust ignore">#![cfg_attr(not(feature = &quot;std&quot;), no_std)]

use jupiter_ink_lang as ink;

#[ink::contract]
mod altbn128 {
    use ink_env::zk_snarks::AltBn128;
    use ink_prelude::string::String;

    #[ink(storage)]
    pub struct Altbn128 {
        value: String,
    }

    impl Altbn128 {
        #[ink(constructor)]
        pub fn new(init_value: String) -&gt; Self {
            Self { value: init_value }
        }

        #[ink(constructor)]
        pub fn default() -&gt; Self {
            Self::new(&quot;hello, world&quot;.into())
        }

        #[ink(message)]
        pub fn bn_256_add(&amp;mut self) {
            let mut result = [0; 64];
            ink_env::inflect_add::&lt;AltBn128&gt;(&amp;[], &amp;[], &amp;mut result);
            self.value = ink_prelude::format!(&quot;0x{:x?}&quot;, result);
        }

        #[ink(message)]
        pub fn get(&amp;self) -&gt; String {
            ink_prelude::format!(&quot;{}&quot;, &amp;self.value)
        }
    }
}
</code></pre>
<h1 id="example-1"><a class="header" href="#example-1">Example</a></h1>
<h2 id="call-curves-in-ink"><a class="header" href="#call-curves-in-ink">Call curves in ink!</a></h2>
<table><thead><tr><th>curve</th><th>add</th><th>mul</th><th>pairing</th></tr></thead><tbody>
<tr><td>bls12_377</td><td>0x01000000</td><td>0x01000001</td><td>0x01000002</td></tr>
<tr><td>bls12_381</td><td>0x01000010</td><td>0x01000011</td><td>0x01000012</td></tr>
<tr><td>bn254</td><td>0x01000020</td><td>0x01000021</td><td>0x01000022</td></tr>
<tr><td>bw6_761</td><td>0x01000030</td><td>0x01000031</td><td>0x01000032</td></tr>
</tbody></table>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let result = ink_env::call_chain_extension(func_id, &amp;Vec::from(input))?
<span class="boring">}
</span></code></pre></pre>
<h2 id="mimc"><a class="header" href="#mimc">MIMC</a></h2>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use zkp_u256::{U256, Zero};
use merkle_tree::mimc::{mimc,mimc_with_key}
let message = U256::from_decimal_str(&quot;49&quot;).unwrap();
let in_key = U256::zero();
assert_eq!(
    mimc(b&quot;1&quot;),
    mimc_with_key(vec![&amp;message], &amp;in_key)
);
<span class="boring">}
</span></code></pre></pre>
<h2 id="merkle-tree"><a class="header" href="#merkle-tree">Merkle Tree</a></h2>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use merkle_tree::MerkleTree;
let mut mt = MerkleTree::default();
let message = b&quot;49&quot;;
let (leaf, index) = mt.insert(message).unwrap();
assert_eq!(mt.update(), mt.get_root());
let merkle_proof = mt.get_proof(index);
assert!(mt.verify_merkle_proof(leaf, merkle_proof, index));

let message = b&quot;50&quot;;
let (leaf, index) = mt.insert(message).unwrap();
assert_eq!(mt.update(), mt.get_root());
let merkle_proof = mt.get_proof(index);
assert!(mt.verify_merkle_proof(leaf, merkle_proof, index));

let message = b&quot;51&quot;;
let (leaf, index) = mt.insert(message).unwrap();
assert_eq!(mt.update(), mt.get_root());
let merkle_proof = mt.get_proof(index);
assert!(mt.verify_merkle_proof(leaf, merkle_proof, index));
<span class="boring">}
</span></code></pre></pre>
<h2 id="eddsa"><a class="header" href="#eddsa">EDDSA</a></h2>
<blockquote>
<p>TODO</p>
</blockquote>
<h1 id="benchmark"><a class="header" href="#benchmark">Benchmark</a></h1>
<p>We have constructed <a href="https://github.com/patractlabs/megaclite/tree/master/crates/arkworks/src/tests">the tests of megaclite curves</a> in <a href="https://github.com/patractlabs/substrate/blob/features/curve-benchmark/bin/node-template/pallets/template/src/lib.rs">pallet-template</a> which imports the 
curves from megaclite directly(<em>Wasm</em>) and with <a href="https://github.com/patractlabs/substrate/blob/features/curve-benchmark/bin/node-template/io/src/lib.rs">runtime-interface</a>(<em>Native</em>).</p>
<h2 id="building"><a class="header" href="#building">Building</a></h2>
<pre><code class="language-bash"># Clone the branch `curve-benchmark` of our fork
git clone https://github.com/patractlabs/jupiter.git \
    --branch features/runtime-interfaces \
    --depth =1

# Build the template
cargo build -p jupiter-dev --all-features --release

# Check the command benchmark works fine
# ./target/release/jupiter-dev benchmark -p pallet_template -e wasm_bls_12_381_add
./target/release/jupiter-dev benchmark -p pallet_template -e wasm_bls_12_381_add

</code></pre>
<h2 id="result"><a class="header" href="#result">Result</a></h2>
<table><thead><tr><th>memory</th><th>processor</th></tr></thead><tbody>
<tr><td>64GiB System memory</td><td>AMD Ryzen 9 5900X 12-Core Processor</td></tr>
</tbody></table>
<p>Here we test the curevs on ubuntu LTS 20.04, Time is measured in us</p>
<table><thead><tr><th>Curve</th><th>Native</th><th>Time(us)</th><th>WASM</th><th>Time(us)</th><th>Speed(Native/WASM)</th></tr></thead><tbody>
<tr><td>bls12_377(~9.5x)</td><td>native_bls12_377_add</td><td>9.588</td><td>wasm_bls12_377_add</td><td>29.02</td><td>~3x</td></tr>
<tr><td></td><td>native_bls12_377_mul</td><td>183.1</td><td>wasm_bls12_377_mul</td><td>1893</td><td>~10x</td></tr>
<tr><td></td><td>native_bls12_377_pairing_two</td><td>1732</td><td>wasm_bls12_377_pairing_two</td><td>15310</td><td>~7x</td></tr>
<tr><td></td><td>native_bls12_377_mimc_verify</td><td>7484</td><td>wasm_bls12_377_mimc_verify</td><td>64680</td><td>~9x</td></tr>
<tr><td>bls12_381(~10x)</td><td>native_bls12_381_add</td><td>13.9</td><td>wasm_bls12_381_add</td><td>28.31</td><td>~2x</td></tr>
<tr><td></td><td>native_bls12_381_mul</td><td>177.1</td><td>wasm_bls12_381_mul</td><td>1879</td><td>~10x</td></tr>
<tr><td></td><td>native_bls12_381_pairing_two</td><td>1438</td><td>wasm_bls12_381_pairing_two</td><td>14770</td><td>~10x</td></tr>
<tr><td></td><td>native_bls12_381_mimc_verify</td><td>6411</td><td>wasm_bls12_381_mimc_verify</td><td>63260</td><td>~10x</td></tr>
<tr><td>bn254(~5x)</td><td>native_bn254_add</td><td>5.631</td><td>wasm_bn254_add</td><td>16.05</td><td>~3x</td></tr>
<tr><td></td><td>native_bn254_mul</td><td>107.7</td><td>wasm_bn254_mul</td><td>534.3</td><td>~5x</td></tr>
<tr><td></td><td>native_bn254_pairing_two</td><td>1150</td><td>wasm_bn254_pairing_two</td><td>5061</td><td>~5x</td></tr>
<tr><td></td><td>native_bn254_mimc_verify</td><td>4178</td><td>wasm_bn254_mimc_verify</td><td>19850</td><td>~5x</td></tr>
<tr><td>bw6_761(~13x)</td><td>native_bw6_761_add</td><td>30.35</td><td>wasm_bw6_761_add</td><td>26.79</td><td>\</td></tr>
<tr><td></td><td>native_bw6_761_mul</td><td>963.8</td><td>wasm_bw6_761_mul</td><td>14630</td><td>~15x</td></tr>
<tr><td></td><td>native_bw6_761_pairing_two</td><td>5715</td><td>wasm_bw6_761_pairing_two</td><td>60960</td><td>~10x</td></tr>
<tr><td></td><td>native_bw6_761_mimc_verify</td><td>20330</td><td>wasm_bw6_761_mimc_verify</td><td>299800</td><td>~15x</td></tr>
</tbody></table>
<pre><code class="language-bash"># 1. Under the jupiter repo
# 2. Has compiled jupiter-dev
sh ./benchmark.sh
</code></pre>
<h1 id="milestones"><a class="header" href="#milestones">Milestones</a></h1>
<h3 id="m1-integrate-the-basic-units-of-alt_bn128--bls12_381-3-developer--1-weeks"><a class="header" href="#m1-integrate-the-basic-units-of-alt_bn128--bls12_381-3-developer--1-weeks">M1: Integrate the basic units of alt_bn128 &amp; bls12_381 (3 developer * 1 weeks)</a></h3>
<ol>
<li>Prepare the 3 basic algorithm codes (Add, Scalar_Mul, and Pairing) of alt_bn128 elliptic curve from zcash's official library <a href="https://github.com/zcash-hackworks/bn">bn</a>.</li>
<li>Prepare the same 3  basic algorithm codes of bls12_381 from zcash's official library <a href="https://github.com/zkcrypto/bls12_381">bls12_381</a> .</li>
<li>Integrate the above 6 algorithms into the under layer of Substrate Runtime.</li>
</ol>
<h3 id="m2-provide-to-upper-runtime-and-smart-contract-applications-3-developers--1-weeks"><a class="header" href="#m2-provide-to-upper-runtime-and-smart-contract-applications-3-developers--1-weeks">M2: Provide to upper runtime and smart contract applications (3 developers * 1 weeks)</a></h3>
<ol>
<li>Add Runtime_interface to the Jupiter testnet and provide it to Runtime applications.</li>
<li>Add Contract_Seal to the contract module of the Jupiter testnet and provide it to the WASM contract application.</li>
</ol>
<h3 id="m3-integrate-upper-level-verification-and-tool-functions-3-developers--1-week"><a class="header" href="#m3-integrate-upper-level-verification-and-tool-functions-3-developers--1-week">M3: Integrate upper-level verification and tool functions (3 developers * 1 week)</a></h3>
<ol>
<li>The runtime pallet that implements the zkSNARK verification algorithm.</li>
<li>The Metis contract library that implements the zkSNARK verification algorithm.</li>
<li>The Metis contract library that implements other commonly used algorithms, such as Poseidon, EdDSA, MerkleTree, MiMC and other commonly used algorithms.</li>
</ol>
<h3 id="m4-test-3-developers--1-week"><a class="header" href="#m4-test-3-developers--1-week">M4: Test (3 developers * 1 week)</a></h3>
<ol>
<li>Test six basic elliptic curve algorithms</li>
<li>Test the zkSNARK verification algorithm of the Runtime layer</li>
<li>Test the zkSNARK verification algorithm implemented in the contract layer</li>
<li>Test Poseidon, EdDSA, MerkleTree, MiMC and other commonly used algorithm contract templates.</li>
</ol>
<h3 id="m5-benchmark-3-developers--1-week"><a class="header" href="#m5-benchmark-3-developers--1-week">M5: Benchmark (3 developers * 1 week)</a></h3>
<ol>
<li>Provide benchmark results of all the above functions and develop them for the community as a reference for transaction weight and pricing.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
